---
hide_table_of_contents: true
---

# Register a contract with the FeeShare module

The x/FeeShare module allows smart contracts to receive a portion of the gas fees generated by interactions with the contract. Use this guide to learn how to register your contract and earn a portion of transaction fees. 

The following code shows an integration test for the fee share module that deploys a smart contract, registers the contract with the FeeShare module, executes a transaction, and checks that the correct portion of fees has been received. 

<CH.Scrollycoding>

## Setup

1. The first portion of the code is used to import the necessary functions, classes, and objects from the [feather.js SDK](https://github.com/terra-money/feather.js). 


```js Example.ts mark=1:7
import { getMnemonics } from "../helpers/mnemonics";
import { getLCDClient } from "../helpers/lcd.connection";
import { Coins, Fee, MnemonicKey, MsgExecuteContract, MsgInstantiateContract, MsgRegisterFeeShare, MsgStoreCode } from "@terra-money/feather.js";
import { blockInclusion } from "../helpers/const";
import fs from "fs";
import path from 'path';

describe("Feeshare Module (https://github.com/terra-money/core/tree/release/v2.6/x/feeshare) ", () => {
    // Prepare environment clients, accounts and wallets
    const LCD = getLCDClient();
    const accounts = getMnemonics();
    const wallet = LCD.chain1.wallet(accounts.feeshareMnemonic);
    const feeshareAccountAddress = accounts.feeshareMnemonic.accAddress("terra");
    const randomAccountAddress = new MnemonicKey().accAddress("terra");
    let contractAddress: string;

    // Reat the reflect contract, store on chain, 
    // instantiate to be used in the following tests
    // and finally save the contract address.
    beforeAll(async () => {
        try {
            let tx = await wallet.createAndSignTx({
                msgs: [new MsgStoreCode(
                    feeshareAccountAddress,
                    fs.readFileSync(path.join(__dirname, "/../contracts/reflect.wasm")).toString("base64"),
                )],
                chainID: "test-1",
            });

            let result = await LCD.chain1.tx.broadcastSync(tx, "test-1");
            await blockInclusion();
            let txResult = await LCD.chain1.tx.txInfo(result.txhash, "test-1") as any;
            let codeId = Number(txResult.logs[0].events[1].attributes[1].value);
            expect(codeId).toBeDefined();

            const msgInstantiateContract = new MsgInstantiateContract(
                feeshareAccountAddress,
                codeId,
                {},
                Coins.fromString("1uluna"),
                "Reflect contract " + Math.random(),
            );

            tx = await wallet.createAndSignTx({
                msgs: [msgInstantiateContract],
                chainID: "test-1",
            });
            result = await LCD.chain1.tx.broadcastSync(tx, "test-1");
            await blockInclusion();
            txResult = await LCD.chain1.tx.txInfo(result.txhash, "test-1") as any;
            contractAddress = txResult.logs[0].eventsByType.instantiate._contract_address[0];
            expect(contractAddress).toBeDefined();
        }
        catch (e) {
            expect(e).toBeUndefined();
        }
    });

    test('Must contain the expected module params', async () => {
        try {
            // Query POB module params
            const moduleParams = await LCD.chain1.feeshare.params("test-1");

            expect(moduleParams)
                .toMatchObject({
                    "params": {
                        "enable_fee_share": true,
                        "developer_shares": "0.500000000000000000",
                        "allowed_denoms": []
                    }
                });
        }
        catch (e) {
            expect(e).toBeUndefined();
        }
    });

    test('Must register fee share', async () => {
        try {
            // Register feeshare
            let tx = await wallet.createAndSignTx({
                msgs: [new MsgRegisterFeeShare(
                    contractAddress,
                    feeshareAccountAddress,
                    randomAccountAddress,
                )],
                chainID: "test-1",
            });

            let result = await LCD.chain1.tx.broadcastSync(tx, "test-1");
            await blockInclusion();

            // Check the tx logs
            let txResult = await LCD.chain1.tx.txInfo(result.txhash, "test-1") as any;
            expect(txResult.logs[0].events)
                .toMatchObject([{
                    "type": "message",
                    "attributes": [{
                        "key": "action",
                        "value": "/juno.feeshare.v1.MsgRegisterFeeShare"
                    }, {
                        "key": "sender",
                        "value": feeshareAccountAddress,
                    }, {
                        "key": "module",
                        "value": "feeshare"
                    }]
                },
                {
                    "type": "register_feeshare",
                    "attributes": [{
                        "key": "contract",
                        "value": contractAddress
                    }, {
                        "key": "withdrawer_address",
                        "value": randomAccountAddress,
                    }]
                }])

            // Check the registered feeshares by contractAddress
            let feesharesBy = await LCD.chain1.feeshare.feeshares("test-1", contractAddress);
            expect(feesharesBy)
                .toMatchObject({
                    "feeshare": {
                        "contract_address": contractAddress,
                        "deployer_address": feeshareAccountAddress,
                        "withdrawer_address": randomAccountAddress,
                    }
                })
            // Check that querying all feeshares returns at least one feeshares
            let feesharesByWallet = await LCD.chain1.feeshare.feeshares("test-1");
            expect(feesharesByWallet.feeshare.length).toBeGreaterThan(0);

            // Send an execute message to the reflect contract
            let msgExecute = new MsgExecuteContract(
                feeshareAccountAddress,
                contractAddress,
                {
                    change_owner: {
                        owner: randomAccountAddress,
                    }
                },
            );
            tx = await wallet.createAndSignTx({
                msgs: [msgExecute],
                chainID: "test-1",
                fee: new Fee(200_000, "400000uluna"),
            });
            result = await LCD.chain1.tx.broadcastSync(tx, "test-1");
            await blockInclusion();
            
            // Check the tx logs have the expected events
            txResult = await LCD.chain1.tx.txInfo(result.txhash, "test-1") as any;
            expect(txResult.logs[0].events)
                .toMatchObject([{
                    "type": "message",
                    "attributes": [{
                        "key": "action",
                        "value": "/cosmwasm.wasm.v1.MsgExecuteContract"
                    }, {
                        "key": "sender",
                        "value": feeshareAccountAddress
                    }, {
                        "key": "module",
                        "value": "wasm"
                    }]
                },
                {
                    "type": "execute",
                    "attributes": [{
                        "key": "_contract_address",
                        "value": contractAddress
                    }]
                },
                {
                    "type": "wasm",
                    "attributes": [{
                        "key": "_contract_address",
                        "value": contractAddress
                    }, {
                        "key": "action",
                        "value": "change_owner"
                    }, {
                        "key": "owner",
                        "value": randomAccountAddress
                    }]
                }
                ])
            
            // Query the random account (new owner of the contract)
            // and validate that the account has received 50% of the fees
            const bankAmount = await LCD.chain1.bank.balance(randomAccountAddress);
            expect(bankAmount[0])
                .toMatchObject(Coins.fromString("200000uluna"))
        }
        catch (e) {
            expect(e).toBeUndefined();
        }
    });
});
```

---

2. The next few lines prepare the environment by initializing Terra's [Light Client Daemon](../feather-js/getting-started.mdx#2-initialize-the-lcd) and setting up the wallets and accounts. 
```js Example.ts focus=8:15

```

---

## Deploy the contract

1. This code creates and signs a transaction to store the smart contract on the blockchain. 

```js Example.ts focus=22:34

```

---

2. A contract instantiation message is created and signed to deploy the contract to the blockchain. The contract has an initial balance of `1uluna`. 


```js Example.ts focus=36:53

```

---

## Registering with the FeeShare module

1. The contract is registered with the FeeShare module by executing a `MsgRegisterFeeShare` transaction. This message is created by supplying it with the following addresses:

    - The address of the contract (_`contractAddress`_)
    - The address of the sender (_`feeshareAccountAddress`_)
    - An address to which the fee revenue will be withdrawn (_`randomAccountAddress`_)


```js Example.ts focus=81:91

```


---

2. The next few lines are part of the test, and check that the address has been registered with the Feeshare module. 


```js Example.ts focus=94:130

```

---


## Checking for fees

1. In this example, a transaction is created by executing the sample contract's _`change_owner`_ message along with a fee for the transaction. 

```js Example.ts focus=135:150

```

---

2. To check that the FeeShare is working properly, the _`withdrawer_address`_ is queried. In this code, the expected portion of fees sent to a contract's registered _`withdrawer_address`_ is _`0.500000000000000000`_, or half of the fees. If the module is working properly, half of the fees (_`200000uluna`_) are expected to be sent to the _`withdrawer_address`_. 

```js Example.ts 192:194

```


</CH.Scrollycoding>